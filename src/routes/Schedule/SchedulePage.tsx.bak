import React, {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
  lazy,
  Suspense,
} from "react";
import FullCalendar from "@fullcalendar/react";
import dayGridPlugin from "@fullcalendar/daygrid";
import timeGridPlugin from "@fullcalendar/timegrid";
import interactionPlugin from "@fullcalendar/interaction";

import {
  Box,
  Button,
  Typography,
  Paper,
  Grid,
  ToggleButtonGroup,
  ToggleButton,
  List,
  ListItem,
  ListItemText,
  ListItemButton,
  ListItemIcon,
  Alert,
  AlertTitle,
  useTheme,
  TextField,
  IconButton,
  Drawer,
  FormControlLabel,
  CircularProgress,
  useMediaQuery,
  Divider,
  Tooltip,
  Checkbox,
  Menu,
  MenuItem,
  TableContainer,
  Table,
  TableHead,
  TableBody,
  TableRow,
  TableCell,
  Chip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
} from "@mui/material";
import {
  CalendarMonth,
  ViewWeek,
  AccessTime,
  MoreVert,
  PersonAdd,
  AssignmentLate,
  Assignment,
  NotificationsActive,
  FilterAlt,
  AssignmentInd,
  Settings as SettingsIcon,
  Add as AddIcon,
  ContentCopy as ContentCopyIcon,
  Close as CloseIcon,
} from "@mui/icons-material";
import ShiftDialog from "./ShiftDialog";
import {
  getEmployees,
  getStoreInfo,
  getShifts,
  saveShift,
} from "../../services/api";
import { Employee, Store, Shift, Availability } from "../../lib/types";
import { useNavigate } from "react-router-dom";
import { v4 as uuidv4 } from "uuid";
import {
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  addDays,
  format,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  parseISO,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  set,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  startOfDay,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  addHours,
  differenceInHours,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  getHours,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  addMinutes,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  parse,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  isWithinInterval,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  isSameDay,
} from "date-fns";
import TemplateManagerDialog from "./TemplateManagerDialog";

// ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ ErrorBoundary í´ë˜ìŠ¤ ì¶”ê°€
class ErrorBoundary extends React.Component<
  { children: React.ReactNode; fallback: React.ReactNode },
  { hasError: boolean }
> {
  constructor(props: { children: React.ReactNode; fallback: React.ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(_: Error) {
    return { hasError: true };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error("ìº˜ë¦°ë” ë Œë”ë§ ì˜¤ë¥˜:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback;
    }

    return this.props.children;
  }
}

// ê·¼ë¬´ ì´ë²¤íŠ¸ ë°ì´í„° êµ¬ì¡°
interface ShiftEvent {
  id: string;
  title: string;
  start: string; // ISO string
  end: string;
  color?: string;
  extendedProps?: {
    employeeIds?: string[];
    employeeNames?: string[];
    note?: string;
    recurring?: {
      frequency: "weekly";
      daysOfWeek?: number[];
      endDate?: string;
    };
    isSubstituteRequest?: boolean;
    isHighPriority?: boolean;
    status?: "unassigned" | "assigned" | "substitute-requested";
    shiftType?: "open" | "middle" | "close";
    requiredStaff?: number;
    templateId?: string; // í…œí”Œë¦¿ ID ì¶”ê°€
  };
}

// ì‹œê°„ëŒ€ í…œí”Œë¦¿ íƒ€ì… ì¶”ê°€
interface ShiftTemplate {
  id: string;
  name: string;
  type: "open" | "middle" | "close";
  startTime: string; // 'HH:MM' í¬ë§·
  endTime: string; // 'HH:MM' í¬ë§·
  requiredStaff: number;
  color: string;
}

// ê¸°ë³¸ í…œí”Œë¦¿ ì •ì˜
const DEFAULT_SHIFT_TEMPLATES: ShiftTemplate[] = [
  {
    id: "template-open",
    name: "ì˜¤í”ˆ",
    type: "open",
    startTime: "09:00",
    endTime: "13:00",
    requiredStaff: 1,
    color: "#4CAF50", // ì´ˆë¡ìƒ‰
  },
  {
    id: "template-middle",
    name: "ë¯¸ë“¤",
    type: "middle",
    startTime: "12:00",
    endTime: "17:00",
    requiredStaff: 2,
    color: "#2196F3", // íŒŒë‘ìƒ‰
  },
  {
    id: "template-close",
    name: "ë§ˆê°",
    type: "close",
    startTime: "16:00",
    endTime: "21:00",
    requiredStaff: 2,
    color: "#9C27B0", // ë³´ë¼ìƒ‰
  },
];

// ì•Œë°”ìƒë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ìµœëŒ€ 10ëª…)
const EMPLOYEE_COLORS = [
  "#4285F4", // íŒŒë‘
  "#EA4335", // ë¹¨ê°•
  "#FBBC05", // ë…¸ë‘
  "#34A853", // ì´ˆë¡
  "#8E24AA", // ë³´ë¼
  "#16A2B8", // ì²­ë¡
  "#F6BF26", // í™©ê¸ˆ
  "#F57C00", // ì£¼í™©
  "#1E88E5", // í•˜ëŠ˜
  "#6E85B7", // ë‚¨ìƒ‰
];

// ìº˜ë¦°ë”ë¥¼ ê°œë³„ ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬í•˜ì—¬ ë Œë”ë§ ìµœì í™”
const ScheduleCalendar: React.FC<{
  calendarRef: React.RefObject<any>;
  viewType: "timeGridWeek" | "dayGridMonth";
  events: ShiftEvent[];
  isMobile: boolean;
  showSidePanel: boolean;
  theme: any;
  onDateSelect: (selectInfo: any) => void;
  onEventClick: (clickInfo: any) => void;
  onEventDrop: (dropInfo: any) => void;
  onEventResize: (resizeInfo: any) => void;
  renderEventContent: (eventInfo: any) => React.ReactNode;
}> = React.memo(
  ({
    calendarRef,
    viewType,
    events,
    isMobile,
    showSidePanel,
    theme,
    onDateSelect,
    onEventClick,
    onEventDrop,
    onEventResize,
    renderEventContent,
  }) => {
    // React.useEffect ì‚¬ìš©í•˜ì—¬ í´ë¦°ì—… í•¨ìˆ˜ ì¶”ê°€
    React.useEffect(() => {
      return () => {
        // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ í´ë¦°ì—…
        if (calendarRef.current) {
          try {
            const api = calendarRef.current.getApi();
            api.destroy();
          } catch (err) {
            console.error("ìº˜ë¦°ë” í´ë¦°ì—… ì˜¤ë¥˜:", err);
          }
        }
      };
    }, [calendarRef]);

    return (
      <FullCalendar
        ref={calendarRef}
        plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
        initialView={viewType}
        headerToolbar={{
          left: isMobile ? "prev,next" : "prev,next today",
          center: "title",
          right: "",
        }}
        editable={true}
        droppable={true}
        selectable={true}
        selectMirror={true}
        dayMaxEvents={isMobile ? 2 : true}
        select={onDateSelect}
        eventClick={onEventClick}
        eventDrop={onEventDrop}
        eventResize={onEventResize}
        eventContent={renderEventContent}
        events={events}
        slotMinTime={"08:00:00"}
        slotMaxTime={"21:30:00"}
        height="auto"
        firstDay={0}
        weekNumbers={false}
        nowIndicator={true}
        allDaySlot={false}
        eventTimeFormat={{
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        }}
        slotDuration="00:30:00"
        snapDuration="00:15:00"
        scrollTime="09:30:00"
        businessHours={{
          daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
          startTime: "09:00",
          endTime: "18:00",
        }}
        viewDidMount={(view) => {
          // ìº˜ë¦°ë” ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì•ˆì „í•œ ì—…ë°ì´íŠ¸
          if (calendarRef.current) {
            try {
              const calendarApi = calendarRef.current.getApi();

              // ì¦‰ì‹œ í•œë²ˆ, ê·¸ë¦¬ê³  ì•½ê°„ì˜ ì§€ì—° í›„ í•œë²ˆ ë” í¬ê¸° ì—…ë°ì´íŠ¸
              calendarApi.updateSize();

              // ìŠ¤ì¼€ì¤„ë§ ì¶©ëŒì´ë‚˜ íƒ€ì´ë° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ setTimeout ì‚¬ìš©
              setTimeout(() => {
                try {
                  if (calendarRef.current) {
                    const api = calendarRef.current.getApi();
                    api.updateSize();

                    // ê°€ì‹œì„± ë¬¸ì œ í™•ì¸
                    if (view.el) {
                      view.el.style.visibility = "visible";
                    }
                  }
                } catch (err) {
                  console.error("ìº˜ë¦°ë” ì§€ì—° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err);
                }
              }, 300);
            } catch (err) {
              console.error("ìº˜ë¦°ë” ì´ˆê¸°í™” ì˜¤ë¥˜:", err);
            }
          }
        }}
        datesSet={() => {
          // ë‚ ì§œ ë³€ê²½ ì‹œ ìº˜ë¦°ë” í¬ê¸° ì—…ë°ì´íŠ¸
          try {
            if (calendarRef.current) {
              const calendarApi = calendarRef.current.getApi();
              calendarApi.updateSize();
            }
          } catch (err) {
            console.error("ë‚ ì§œ ë³€ê²½ ì‹œ ìº˜ë¦°ë” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err);
          }
        }}
        views={{
          dayGridMonth: {
            dayMaxEventRows: isMobile ? 2 : 4,
            fixedWeekCount: false,
            showNonCurrentDates: true,
          },
          timeGridWeek: {
            dayHeaderFormat: { weekday: "short", day: "numeric" },
            slotLabelFormat: {
              hour: "numeric",
              minute: "2-digit",
              omitZeroMinute: false,
              hour12: false,
            },
            slotLabelInterval: "01:00",
            slotEventOverlap: false,
            expandRows: true,
            dayHeaderContent: (args) => {
              const weekdayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
              const dayOfWeek = args.date.getDay();
              const weekday = weekdayNames[dayOfWeek];
              const day = args.date.getDate();
              const className =
                dayOfWeek === 0
                  ? "fc-day-sun"
                  : dayOfWeek === 6
                  ? "fc-day-sat"
                  : "";
              return {
                html: `<div class="fc-day-header ${className}">${weekday}<br/>${day}</div>`,
              };
            },
          },
        }}
        dayCount={7}
        eventClassNames={(arg) => {
          const classes = [];

          if (!arg.event.extendedProps?.employeeIds?.length) {
            classes.push("fc-event-unassigned");
          }

          if (arg.event.extendedProps?.isSubstituteRequest) {
            classes.push("fc-event-substitute-requested");

            if (arg.event.extendedProps?.isHighPriority) {
              classes.push("fc-event-high-priority");
            }
          }

          return classes;
        }}
      />
    );
  }
);

const SchedulePage: React.FC = () => {
  const navigate = useNavigate();
  const theme = useTheme();
  const calendarRef = useRef<any>(null); // Add ref for direct calendar control
  const isMobile = useMediaQuery(theme.breakpoints.down("sm"));

  const [viewType, setViewType] = useState<"timeGridWeek" | "dayGridMonth">(
    "timeGridWeek"
  );
  const [events, setEvents] = useState<ShiftEvent[]>([]);
  const [selectedEvent, setSelectedEvent] = useState<ShiftEvent | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [isNewEvent, setIsNewEvent] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [store, setStore] = useState<Store | null>(null);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [filteredEmployeeIds, setFilteredEmployeeIds] = useState<string[]>([]);
  const [showSidePanel, setShowSidePanel] = useState(true);

  // ì¶”ê°€ëœ ìƒíƒœ
  const [availabilityFilter, setAvailabilityFilter] = useState<{
    start: string;
    end: string;
  } | null>(null);
  const [showUnassignedOnly, setShowUnassignedOnly] = useState(false);
  const [employeeAvailability, setEmployeeAvailability] = useState<
    Availability[]
  >([]);

  // í…œí”Œë¦¿ ê´€ë ¨ ìƒíƒœ ì¶”ê°€
  const [shiftTemplates, setShiftTemplates] = useState<ShiftTemplate[]>(
    DEFAULT_SHIFT_TEMPLATES
  );
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const [selectedDay, setSelectedDay] = useState<Date | null>(null);
  const [isTemplateManagerOpen, setIsTemplateManagerOpen] = useState(false);

  // ì•Œë°”ìƒ IDì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ (useCallbackìœ¼ë¡œ ë©”ëª¨ì´ì œì´ì…˜)
  const getEmployeeColor = useCallback(
    (employeeId?: string): string => {
      if (!employeeId) return EMPLOYEE_COLORS[EMPLOYEE_COLORS.length - 1];

      const index = employees.findIndex((e) => e.id === employeeId);
      if (index === -1) return EMPLOYEE_COLORS[EMPLOYEE_COLORS.length - 1];

      return EMPLOYEE_COLORS[index % EMPLOYEE_COLORS.length];
    },
    [employees]
  );

  // ë§¤ì¥ê³¼ ì•Œë°”ìƒ ì •ë³´ ë¡œë“œ (ì˜ì¡´ì„± ë°°ì—´ ìˆ˜ì •)
  useEffect(() => {
    let isMounted = true; // ë§ˆìš´íŠ¸ ìƒíƒœ ì¶”ì ìš© í”Œë˜ê·¸

    const loadData = async () => {
      try {
        if (!isMounted) return; // ì´ë¯¸ ì–¸ë§ˆìš´íŠ¸ëœ ê²½ìš° í•¨ìˆ˜ ì¢…ë£Œ

        setLoading(true);
        setError(null); // ì—ëŸ¬ ìƒíƒœ ì´ˆê¸°í™”

        // ë§¤ì¥ ì •ë³´ ë¡œë“œ
        let storeData;
        try {
          storeData = await getStoreInfo();
          console.log("ë§¤ì¥ ì •ë³´ ë¡œë“œ:", storeData);

          if (!isMounted) return; // ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ëëŠ”ì§€ í™•ì¸

          if (!storeData || !storeData.id) {
            console.error("ë§¤ì¥ ì •ë³´ê°€ ì—†ê±°ë‚˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            setError(
              "ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§¤ì¥ ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”."
            );
            setLoading(false);
            return;
          }

          setStore(storeData);
        } catch (storeErr) {
          console.error("ë§¤ì¥ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:", storeErr);
          if (!isMounted) return;

          setError(
            "ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§¤ì¥ ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”."
          );
          setLoading(false);
          return;
        }

        // ì§ì› ì •ë³´ ë¡œë“œ
        let employeesData = [];
        try {
          employeesData = await getEmployees();
          console.log("ì§ì› ì •ë³´ ë¡œë“œ:", employeesData);

          if (!isMounted) return;

          setEmployees(employeesData || []);

          // ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì•Œë°”ìƒ í•„í„°ì— í¬í•¨
          setFilteredEmployeeIds((employeesData || []).map((emp) => emp.id));
        } catch (empErr) {
          console.error("ì§ì› ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:", empErr);
          // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¹ˆ ë°°ì—´ë¡œ ê³„ì† ì§„í–‰
          if (!isMounted) return;

          employeesData = [];
          setEmployees([]);
          setFilteredEmployeeIds([]);
        }

        // ê·¼ë¬´ ì¼ì • ë¡œë“œ
        let shifts = [];
        try {
          shifts = await getShifts();
          console.log("ê·¼ë¬´ ì¼ì • ë¡œë“œ:", shifts);

          if (!isMounted) return;
        } catch (shiftErr) {
          console.error("ê·¼ë¬´ ì¼ì • ë¡œë“œ ì˜¤ë¥˜:", shiftErr);
          if (!isMounted) return;

          shifts = []; // ê¸°ë³¸ê°’ ì„¤ì •
        }

        // ê°€ìƒì˜ ê°€ëŠ¥ ì‹œê°„ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
        const availabilityData: Availability[] = (employeesData || []).flatMap(
          (emp) =>
            Array.from({ length: 7 }, (_, i) => ({
              employeeId: emp.id,
              dayOfWeek: i as 0 | 1 | 2 | 3 | 4 | 5 | 6,
              startTime: i % 2 === 0 ? "09:00" : "14:00",
              endTime: i % 2 === 0 ? "15:00" : "22:00",
              isRecurring: true,
              exceptionDates: [],
            }))
        );

        if (!isMounted) return;
        setEmployeeAvailability(availabilityData);

        // ëŒ€íƒ€ ìš”ì²­ ìƒíƒœë¥¼ í¬í•¨í•˜ë„ë¡ ì—…ë°ì´íŠ¸ (ë°ëª¨ìš© ë°ì´í„°)
        const processedEvents = (shifts || []).map((shift: Shift) => {
          // ì„ì˜ë¡œ ì¼ë¶€ ê·¼ë¬´ë¥¼ ëŒ€íƒ€ ìš”ì²­ ìƒíƒœë¡œ ì„¤ì • (ë°ëª¨ìš©)
          const hasSubRequest = Math.random() > 0.8;
          const isHighPriority = hasSubRequest && Math.random() > 0.5;

          // ì§ì› ì´ë¦„ ì°¾ê¸°ë¥¼ ìœ„í•œ ì•ˆì „í•œ ë°©ë²•
          const employeeNames = (shift.employeeIds || []).map((id: string) => {
            const employee = (employeesData || []).find((e) => e.id === id);
            return employee ? employee.name : "Unknown";
          });

          return {
            id: shift.id,
            title: shift.title || "",
            start: shift.start,
            end: shift.end,
            color: getEmployeeColor(shift.employeeIds?.[0]),
            extendedProps: {
              employeeIds: shift.employeeIds || [],
              employeeNames: employeeNames,
              note: shift.note,
              recurring: shift.isRecurring
                ? {
                    frequency: "weekly" as const,
                    daysOfWeek: [new Date(shift.start).getDay()],
                  }
                : undefined,
              isSubstituteRequest: hasSubRequest,
              isHighPriority: isHighPriority,
              status: !shift.employeeIds?.length
                ? ("unassigned" as const)
                : hasSubRequest
                ? ("substitute-requested" as const)
                : ("assigned" as const),
            },
          } as ShiftEvent;
        });

        if (!isMounted) return;
        setEvents(processedEvents);
      } catch (err) {
        console.error("Error loading data:", err);
        if (!isMounted) return;

        setError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        // ëª¨ë“  ê³¼ì •ì´ ëë‚œ í›„ í•­ìƒ ë¡œë”© ìƒíƒœ í•´ì œ
        if (isMounted) {
          setLoading(false);
        }
      }
    };

    loadData();

    // í´ë¦°ì—… í•¨ìˆ˜: ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ë  ë•Œ í˜¸ì¶œë¨
    return () => {
      isMounted = false;
    };
  }, [getEmployeeColor]); // getEmployeeColorë¥¼ ì˜ì¡´ì„± ë°°ì—´ì— í¬í•¨

  // í•„í„°ë§ëœ ì´ë²¤íŠ¸
  const filteredEvents = useMemo(() => {
    let filtered = events;

    // ì§ì› í•„í„° ì ìš©
    if (filteredEmployeeIds.length > 0) {
      filtered = filtered.filter((event) => {
        // ë¯¸ë°°ì • ì´ë²¤íŠ¸ëŠ” í•­ìƒ í‘œì‹œ
        if (!event.extendedProps?.employeeIds?.length) return true;

        return event.extendedProps.employeeIds.some((id) =>
          filteredEmployeeIds.includes(id)
        );
      });
    }

    // ë¯¸ë°°ì • ê·¼ë¬´ë§Œ ë³´ê¸° í•„í„°
    if (showUnassignedOnly) {
      filtered = filtered.filter(
        (event) =>
          !event.extendedProps?.employeeIds?.length ||
          event.extendedProps.employeeIds.length === 0
      );
    }

    // ê°€ëŠ¥ ì‹œê°„ í•„í„° ì ìš©ì€ ìœ ì§€í•˜ë˜ í•„í„° ì ìš© ë¡œì§ ê°œì„ 
    if (
      availabilityFilter &&
      availabilityFilter.start &&
      availabilityFilter.end
    ) {
      const filterStartHour = parseInt(
        availabilityFilter.start.split(":")[0],
        10
      );
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const filterStartMinute = parseInt(
        availabilityFilter.start.split(":")[1],
        10
      );
      const filterEndHour = parseInt(availabilityFilter.end.split(":")[0], 10);
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const filterEndMinute = parseInt(
        availabilityFilter.end.split(":")[1],
        10
      );

      // í•´ë‹¹ ì‹œê°„ì— ê·¼ë¬´ ê°€ëŠ¥í•œ ì§ì› ì°¾ê¸° (ì•ˆì „ ìˆ˜ì •)
      const availableEmployeeIds = employees
        .filter((emp) => {
          // í•´ë‹¹ ì§ì›ì˜ ê°€ëŠ¥ ì‹œê°„ í™•ì¸ (ì•ˆì „í•˜ê²Œ ë°°ì—´ ì²´í¬)
          const hasAvailability = employeeAvailability.some(
            (avail) =>
              avail.employeeId === emp.id &&
              parseInt(avail.startTime.split(":")[0], 10) <= filterStartHour &&
              parseInt(avail.endTime.split(":")[0], 10) >= filterEndHour
          );
          return hasAvailability;
        })
        .map((emp) => emp.id);

      if (availableEmployeeIds.length > 0) {
        // í•„í„°ë§ëœ ì§ì› ID ì—…ë°ì´íŠ¸
        setFilteredEmployeeIds(availableEmployeeIds);
      }
    }

    return filtered;
  }, [
    events,
    filteredEmployeeIds,
    availabilityFilter,
    employeeAvailability,
    employees,
    showUnassignedOnly,
  ]);

  // ë¯¸ë°°ì • ê·¼ë¬´ ë¸”ë¡ ëª©ë¡
  const unassignedShifts = useMemo(() => {
    return events.filter(
      (event) =>
        !event.extendedProps?.employeeIds?.length ||
        event.extendedProps.employeeIds.length === 0
    );
  }, [events]);

  // ëŒ€íƒ€ ìš”ì²­ì´ ìˆëŠ” ê·¼ë¬´ ëª©ë¡
  const substituteRequestShifts = useMemo(() => {
    return events
      .filter((event) => event.extendedProps?.isSubstituteRequest === true)
      .sort((a, b) => {
        // ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ìš”ì²­ì„ ë¨¼ì € í‘œì‹œ
        if (
          a.extendedProps?.isHighPriority &&
          !b.extendedProps?.isHighPriority
        ) {
          return -1;
        }
        if (
          !a.extendedProps?.isHighPriority &&
          b.extendedProps?.isHighPriority
        ) {
          return 1;
        }
        return 0;
      });
  }, [events]);

  // ì•Œë°”ìƒë³„ ê·¼ë¬´ ì‹œê°„ ê³„ì‚° (ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ì— eslint ì£¼ì„ ì¶”ê°€)
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const employeeHours = useMemo(() => {
    return employees.map((employee) => {
      const employeeEvents = events.filter((event) =>
        event.extendedProps?.employeeIds?.includes(employee.id)
      );

      const totalHours = employeeEvents.reduce((total, event) => {
        const hours = differenceInHours(
          new Date(event.end),
          new Date(event.start)
        );
        return total + hours;
      }, 0);

      return {
        employee,
        totalHours,
        shiftsCount: employeeEvents.length,
        color: getEmployeeColor(employee.id),
      };
    });
  }, [employees, events, getEmployeeColor]);

  // ì§ì› í•„í„° í† ê¸€
  const handleEmployeeFilter = (employeeId: string) => {
    setFilteredEmployeeIds((prev) => {
      if (prev.includes(employeeId)) {
        return prev.filter((id) => id !== employeeId);
      } else {
        return [...prev, employeeId];
      }
    });
  };

  // ê°€ëŠ¥ ì‹œê°„ í•„í„° ë³€ê²½ ì²˜ë¦¬
  const handleAvailabilityFilterChange = (
    key: "start" | "end",
    value: string
  ) => {
    setAvailabilityFilter((prev) => ({
      ...(prev || { start: "09:00", end: "18:00" }),
      [key]: value,
    }));
  };

  // í•„í„° ì´ˆê¸°í™”
  const resetFilters = () => {
    setAvailabilityFilter(null);
    setFilteredEmployeeIds(employees.map((emp) => emp.id));
    setShowUnassignedOnly(false);
  };

  // ë·° íƒ€ì… ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleViewChange = (
    _: React.MouseEvent<HTMLElement>,
    newView: "timeGridWeek" | "dayGridMonth" | null
  ) => {
    if (newView) {
      setViewType(newView);
      // Directly control the calendar API to change view
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        calendarApi.changeView(newView);
      }
    }
  };

  // í…œí”Œë¦¿ ë©”ë‰´ ì—´ê¸° í•¸ë“¤ëŸ¬
  const handleOpenTemplateMenu = (
    event: React.MouseEvent<HTMLElement>,
    date: Date
  ) => {
    setAnchorEl(event.currentTarget);
    setSelectedDay(date);
  };

  // í…œí”Œë¦¿ ë©”ë‰´ ë‹«ê¸° í•¸ë“¤ëŸ¬
  const handleCloseTemplateMenu = () => {
    setAnchorEl(null);
  };

  // í…œí”Œë¦¿ìœ¼ë¡œ ê·¼ë¬´ ìƒì„± í•¸ë“¤ëŸ¬
  const handleCreateShiftFromTemplate = (template: ShiftTemplate) => {
    if (!selectedDay) return;

    // ì„ íƒí•œ ë‚ ì§œ ì •ë³´ í™œìš©
    const day = selectedDay;

    // í…œí”Œë¦¿ì˜ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ íŒŒì‹±
    const [startHour, startMinute] = template.startTime.split(":").map(Number);
    const [endHour, endMinute] = template.endTime.split(":").map(Number);

    // ì„ íƒí•œ ë‚ ì§œì— ì‹œê°„ ì„¤ì •
    const startDate = new Date(day);
    startDate.setHours(startHour, startMinute, 0);

    const endDate = new Date(day);
    endDate.setHours(endHour, endMinute, 0);

    // ìƒˆ ì´ë²¤íŠ¸ ìƒì„±
    const newEvent: ShiftEvent = {
      id: uuidv4(),
      title: template.name,
      start: startDate.toISOString(),
      end: endDate.toISOString(),
      color: template.color,
      extendedProps: {
        employeeIds: [],
        employeeNames: [],
        status: "unassigned",
        shiftType: template.type,
        requiredStaff: template.requiredStaff,
        templateId: template.id, // í…œí”Œë¦¿ ID ì¶”ê°€í•˜ì—¬ ì—°ê²°
      },
    };

    // ì´ë²¤íŠ¸ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
    setSelectedEvent(newEvent);
    setIsNewEvent(true);
    setIsDialogOpen(true);

    // í…œí”Œë¦¿ ë©”ë‰´ ë‹«ê¸°
    handleCloseTemplateMenu();
  };

  // ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const handleDateSelect = (selectInfo: any) => {
    // ì„ íƒí•œ ë‚ ì§œ í™•ì¸ (í´ë¦­í•œ ë‚ ì§œì˜ 0ì‹œ 0ë¶„ ê¸°ì¤€)
    const clickedDate = new Date(selectInfo.start);
    clickedDate.setHours(0, 0, 0, 0);

    // í…œí”Œë¦¿ ë©”ë‰´ í‘œì‹œ (ê°„í¸í•˜ê²Œ ì˜¤í”ˆ/ë¯¸ë“¤/ë§ˆê° ì„ íƒ)
    handleOpenTemplateMenu(selectInfo.jsEvent, clickedDate);

    // ê¸°ì¡´ ë¡œì§ì€ ìœ ì§€ (ê·¸ëŒ€ë¡œ ë“œë˜ê·¸ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
    if (store) {
      const startDate = new Date(selectInfo.start);
      const endDate = new Date(selectInfo.end);

      // ì‹œì‘ì‹œê°„ ì œí•œ (ì˜¤í”ˆ ì‹œê°„ ì´ì „ì´ë©´ ì˜¤í”ˆ ì‹œê°„ìœ¼ë¡œ ì„¤ì •)
      const openingHour = parseInt(store.openingHour.split(":")[0], 10);
      if (startDate.getHours() < openingHour) {
        startDate.setHours(openingHour, 0, 0);
      }

      // ì¢…ë£Œì‹œê°„ ì œí•œ (ë§ˆê° ì‹œê°„ ì´í›„ë©´ ë§ˆê° ì‹œê°„ìœ¼ë¡œ ì„¤ì •)
      const closingHour = parseInt(store.closingHour.split(":")[0], 10);
      if (
        endDate.getHours() > closingHour ||
        (endDate.getHours() === closingHour && endDate.getMinutes() > 0)
      ) {
        endDate.setHours(closingHour, 0, 0);
      }

      // ìœ íš¨í•œ ì„ íƒ í™•ì¸ (ì‹œì‘ì‹œê°„ì´ ì¢…ë£Œì‹œê°„ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•¨)
      if (startDate >= endDate) {
        console.log("Invalid time selection");
        return;
      }

      // ìƒˆ ì´ë²¤íŠ¸ ìƒì„±
      const newEvent: ShiftEvent = {
        id: uuidv4(),
        title: "",
        start: startDate.toISOString(),
        end: endDate.toISOString(),
        extendedProps: {
          employeeIds: [],
          employeeNames: [],
          status: "unassigned",
          shiftType: "middle", // ê¸°ë³¸ê°’ ì„¤ì •
          requiredStaff: 1,
        },
      };

      setSelectedEvent(newEvent);
      setIsNewEvent(true);
      setIsDialogOpen(true);
    }
  };

  // ì´ë²¤íŠ¸ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleEventClick = (info: any) => {
    const clickedEvent = {
      id: info.event.id,
      title: info.event.title,
      start: info.event.startStr,
      end: info.event.endStr,
      color: info.event.backgroundColor,
      extendedProps: info.event.extendedProps,
    };

    // ë¯¸ë°°ì • ê·¼ë¬´ì¸ ê²½ìš° ì¶”ì²œ ëŒ€í™”ìƒì ì—´ê¸°
    if (
      info.event.extendedProps.isUnassigned ||
      info.event.extendedProps.isUnderStaffed
    ) {
      // ì›ë³¸ ê·¼ë¬´ ë°ì´í„° ì°¾ê¸° - shifts ëŒ€ì‹  eventsë¥¼ ì‚¬ìš©
      const originalShift = events.find((e) => e.id === info.event.id);
      if (originalShift) {
        // ShiftEventë¥¼ Shiftë¡œ ë³€í™˜
        const shift: Shift = {
          id: originalShift.id,
          storeId: "store-1", // ê³ ì • ê°’ ì‚¬ìš© (ì¼ë°˜ì ìœ¼ë¡œ í•œ ë§¤ì¥ì—ì„œë§Œ ìŠ¤ì¼€ì¤„ë§í•˜ë¯€ë¡œ)
          title: originalShift.title,
          start: originalShift.start,
          end: originalShift.end,
          employeeIds: originalShift.extendedProps?.employeeIds || [],
          isRecurring: !!originalShift.extendedProps?.recurring,
          color: originalShift.color,
          extendedProps: originalShift.extendedProps,
        };
        openRecommendationDialog(shift);
        return;
      }
    }

    // ì¼ë°˜ ê·¼ë¬´ëŠ” ê¸°ì¡´ì²˜ëŸ¼ í¸ì§‘ ëŒ€í™”ìƒì ì—´ê¸°
    setSelectedEvent(clickedEvent);
    setIsDialogOpen(true); // setIsEventDialogOpen ëŒ€ì‹  setIsDialogOpen ì‚¬ìš©
  };

  // ì´ë²¤íŠ¸ ë“œë˜ê·¸ í•¸ë“¤ëŸ¬
  const handleEventDrop = (dropInfo: any) => {
    // ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì´ë²¤íŠ¸ ì´ë™ ì‹œ
    const updatedEvent = {
      ...dropInfo.event.toPlainObject(),
      start: dropInfo.event.start.toISOString(),
      end: dropInfo.event.end.toISOString(),
      extendedProps: dropInfo.event.extendedProps || {},
    };

    // ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
    saveShiftToApi(updatedEvent);

    // UI ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
    setEvents((prev) =>
      prev.map((ev) => (ev.id === updatedEvent.id ? updatedEvent : ev))
    );
  };

  // ì´ë²¤íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬
  const handleEventResize = (resizeInfo: any) => {
    // ì´ë²¤íŠ¸ í¬ê¸° ì¡°ì ˆ ì‹œ
    const updatedEvent = {
      ...resizeInfo.event.toPlainObject(),
      start: resizeInfo.event.start.toISOString(),
      end: resizeInfo.event.end.toISOString(),
      extendedProps: resizeInfo.event.extendedProps || {},
    };

    // ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
    saveShiftToApi(updatedEvent);

    // UI ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
    setEvents((prev) =>
      prev.map((ev) => (ev.id === updatedEvent.id ? updatedEvent : ev))
    );
  };

  // ê·¼ë¬´ ì¼ì • ì €ì¥ í•¸ë“¤ëŸ¬
  const handleSaveShift = (shiftEvent: ShiftEvent) => {
    // ìƒˆ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì¶”ê°€
    if (isNewEvent) {
      setEvents((prev) => [...prev, shiftEvent]);
    } else {
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
      setEvents((prev) =>
        prev.map((ev) => (ev.id === shiftEvent.id ? shiftEvent : ev))
      );
    }

    // ì´ë²¤íŠ¸ ì €ì¥ API í˜¸ì¶œ
    saveShiftToApi(shiftEvent);

    // ëŒ€í™”ìƒì ë‹«ê¸°
    setIsDialogOpen(false);
  };

  // APIì— ê·¼ë¬´ ì¼ì • ì €ì¥
  const saveShiftToApi = async (shiftEvent: ShiftEvent) => {
    try {
      // ë§¤ì¥ IDê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 's1' ì‚¬ìš© (ì²« ë²ˆì§¸ ë§¤ì¥ ID)
      const storeId = store?.id || "s1";

      console.log("ê·¼ë¬´ ì¼ì • ì €ì¥ ì‹œë„:", {
        id: shiftEvent.id,
        storeId: storeId,
        employeeIds: shiftEvent.extendedProps?.employeeIds || [],
      });

      const result = await saveShift({
        id: shiftEvent.id,
        storeId: storeId,
        title: shiftEvent.title,
        start: shiftEvent.start,
        end: shiftEvent.end,
        employeeIds: shiftEvent.extendedProps?.employeeIds || [],
        isRecurring: !!shiftEvent.extendedProps?.recurring,
        recurringPattern: shiftEvent.extendedProps?.recurring
          ? {
              frequency: "weekly",
              daysOfWeek: shiftEvent.extendedProps?.recurring?.daysOfWeek || [],
            }
          : undefined,
        note: shiftEvent.extendedProps?.note,
      });

      console.log("ê·¼ë¬´ ì¼ì • ì €ì¥ ì„±ê³µ:", result);
    } catch (err) {
      console.error("Error saving shift:", err);
    }
  };

  // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° í•¸ë“¤ëŸ¬
  const handleCloseDialog = () => {
    setIsDialogOpen(false);
  };

  // ì•Œë°”ìƒ í˜ì´ì§€ë¡œ ì´ë™
  const handleGoToEmployees = () => {
    navigate("/employees");
  };

  // ëŒ€íƒ€ ìš”ì²­ ì²˜ë¦¬
  const handleSubstituteRequest = (
    event: ShiftEvent,
    isHighPriority: boolean = false
  ) => {
    // ëŒ€íƒ€ ìš”ì²­ ìƒíƒœ í† ê¸€
    const isRequestActive = event.extendedProps?.isSubstituteRequest;

    // ëª…ì‹œì ìœ¼ë¡œ ShiftEvent íƒ€ì…ì„ ì§€ì •í•˜ì—¬ íƒ€ì… ì˜¤ë¥˜ í•´ê²°
    const updatedEvent: ShiftEvent = {
      ...event,
      extendedProps: {
        ...event.extendedProps,
        isSubstituteRequest: !isRequestActive,
        isHighPriority: !isRequestActive ? isHighPriority : false,
        status: !isRequestActive ? "substitute-requested" : "assigned",
      },
    };

    // ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
    setEvents((prev) =>
      prev.map((ev) => (ev.id === event.id ? updatedEvent : ev))
    );

    // API ì €ì¥
    saveShiftToApi(updatedEvent);
  };

  // ì´ë²¤íŠ¸ ë Œë”ë§ ì»¤ìŠ¤í„°ë§ˆì´ì§•
  const renderEventContent = (eventInfo: any) => {
    const isSubRequest = eventInfo.event.extendedProps.isSubstituteRequest;
    const isHighPriority = eventInfo.event.extendedProps.isHighPriority;
    const isUnassigned = !eventInfo.event.extendedProps.employeeIds?.length;

    return (
      <Box sx={{ p: 0.5, width: "100%", overflow: "hidden" }}>
        {/* ì œëª© ë° ì•„ì´ì½˜ */}
        <Box sx={{ display: "flex", alignItems: "center", mb: 0.5 }}>
          {isSubRequest && (
            <Tooltip title={isHighPriority ? "ê¸´ê¸‰ ëŒ€íƒ€ ìš”ì²­" : "ëŒ€íƒ€ ìš”ì²­"}>
              <Box component="span" mr={0.5}>
                {isHighPriority ? (
                  <NotificationsActive
                    fontSize="small"
                    color="error"
                    sx={{ animation: "pulse 1.5s infinite" }}
                  />
                ) : (
                  <AssignmentLate fontSize="small" color="warning" />
                )}
              </Box>
            </Tooltip>
          )}

          {isUnassigned && (
            <Tooltip title="ë¯¸ë°°ì • ê·¼ë¬´">
              <Box component="span" mr={0.5}>
                <Assignment fontSize="small" color="disabled" />
              </Box>
            </Tooltip>
          )}

          <Typography
            variant="caption"
            sx={{
              fontWeight: isHighPriority ? "bold" : "normal",
              color: isHighPriority ? "error.main" : "inherit",
            }}
          >
            {eventInfo.event.title || (isUnassigned ? "ë¯¸ë°°ì • ê·¼ë¬´" : "ê·¼ë¬´")}
          </Typography>
        </Box>

        {/* ì‹œê°„ */}
        <Typography variant="caption" display="block">
          {format(new Date(eventInfo.event.start), "HH:mm")} -{" "}
          {format(new Date(eventInfo.event.end), "HH:mm")}
        </Typography>

        {/* ì•Œë°”ìƒ ì´ë¦„ */}
        {eventInfo.event.extendedProps.employeeNames?.map(
          (name: string, idx: number) => (
            <Typography key={idx} variant="caption" display="block" noWrap>
              {name}
            </Typography>
          )
        )}
      </Box>
    );
  };

  // í˜ì´ì§€ ì´ˆê¸° ë¡œë“œì‹œ ëª¨ë°”ì¼ ì—¬ë¶€ì— ë”°ë¼ ì‚¬ì´ë“œíŒ¨ë„ ì„¤ì •
  useEffect(() => {
    setShowSidePanel(!isMobile);
  }, [isMobile]);

  // í…œí”Œë¦¿ ì €ì¥ í•¸ë“¤ëŸ¬ ì¶”ê°€
  const handleSaveTemplates = (updatedTemplates: ShiftTemplate[]) => {
    setShiftTemplates(updatedTemplates);

    // í…œí”Œë¦¿ì„ ì €ì¥ì†Œ(localStorage)ì— ì €ì¥
    try {
      localStorage.setItem("shiftTemplates", JSON.stringify(updatedTemplates));
      console.log("í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:", updatedTemplates);

      // ìº˜ë¦°ë”ì— ë°˜ì˜í•  ìˆ˜ ìˆë„ë¡ í…œí”Œë¦¿ ê´€ë ¨ ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
      // í…œí”Œë¦¿ ë³€ê²½ì´ ê¸°ì¡´ ì´ë²¤íŠ¸ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ ì‹ ì¤‘í•˜ê²Œ ì²˜ë¦¬
      const updatedEvents = events.map((event) => {
        // ì´ë²¤íŠ¸ì— í…œí”Œë¦¿ IDê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ í…œí”Œë¦¿ì˜ ì†ì„± ì—…ë°ì´íŠ¸
        if (event.extendedProps?.templateId) {
          const template = updatedTemplates.find(
            (t) => t.id === event.extendedProps.templateId
          );
          if (template) {
            return {
              ...event,
              title: template.name,
              color: template.color,
              extendedProps: {
                ...event.extendedProps,
                shiftType: template.type,
                requiredStaff: template.requiredStaff,
              },
            };
          }
        }
        return event;
      });

      setEvents(updatedEvents);
      console.log("í…œí”Œë¦¿ ë³€ê²½ì´ ê¸°ì¡´ ì¼ì •ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (err) {
      console.error("í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨:", err);
    }
  };

  // í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ì¶”ê°€
  const loadTemplatesFromStorage = () => {
    try {
      const savedTemplates = localStorage.getItem("shiftTemplates");
      if (savedTemplates) {
        const parsedTemplates = JSON.parse(savedTemplates);
        setShiftTemplates(parsedTemplates);
        console.log(
          "í…œí”Œë¦¿ì´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤:",
          parsedTemplates.length,
          "ê°œ"
        );
      } else {
        console.log(
          "ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í…œí”Œë¦¿ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
        );
      }
    } catch (err) {
      console.error("í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    }
  };

  // í…œí”Œë¦¿ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ íš¨ê³¼ ì¶”ê°€
  useEffect(() => {
    console.log(
      "í…œí”Œë¦¿ ëª©ë¡ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ í…œí”Œë¦¿ ìˆ˜:",
      shiftTemplates.length
    );

    // í…œí”Œë¦¿ ê´€ë ¨ UI ìš”ì†Œ ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì—¬ê¸°ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  }, [shiftTemplates]);

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    loadTemplatesFromStorage();

    // ìë™ìœ¼ë¡œ í…œí”Œë¦¿ ê´€ë¦¬ì ëª¨ë‹¬ ì—´ê¸°
    setTimeout(() => {
      setIsTemplateManagerOpen(true);
    }, 1000);

    // ê°œë°œ ëª©ì ìœ¼ë¡œ ì „ì—­ í•¨ìˆ˜ ì¶”ê°€
    if (typeof window !== "undefined") {
      (window as any).openTemplateManager = () => {
        setIsTemplateManagerOpen(true);
        console.log("í…œí”Œë¦¿ ê´€ë¦¬ì ëª¨ë‹¬ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.");
      };
      (window as any).closeTemplateManager = () => {
        setIsTemplateManagerOpen(false);
        console.log("í…œí”Œë¦¿ ê´€ë¦¬ì ëª¨ë‹¬ì„ ë‹«ì•˜ìŠµë‹ˆë‹¤.");
      };
      console.log(
        "í…œí”Œë¦¿ ê´€ë¦¬ìë¥¼ ì œì–´í•˜ëŠ” í•¨ìˆ˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ window.openTemplateManager() ë˜ëŠ” window.closeTemplateManager()ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”."
      );
    }
  }, []);

  // ê·¼ë¬´ ë¸”ë¡ ì²˜ë¦¬ í•¨ìˆ˜ ìˆ˜ì •
  const processShiftsToEvents = useCallback(
    (shifts: Shift[]) => {
      if (!shifts || !employees) return [];

      const processedEvents = shifts.map((shift) => {
        // ê¸°ë³¸ ì´ë²¤íŠ¸ íƒ€ì… êµ¬ì„±
        const isUnassigned =
          !shift.employeeIds || shift.employeeIds.length === 0;
        const isUnderStaffed =
          shift.employeeIds && shift.extendedProps?.minStaff
            ? shift.employeeIds.length < shift.extendedProps.minStaff
            : false;
        const isOverStaffed =
          shift.employeeIds && shift.extendedProps?.maxStaff
            ? shift.employeeIds.length > shift.extendedProps.maxStaff
            : false;

        // ì§ì› ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const employeeNames = shift.employeeIds
          ? shift.employeeIds.map((id) => {
              const emp = employees.find((e) => e.id === id);
              return emp ? emp.name : "Unknown";
            })
          : [];

        // ì´ë²¤íŠ¸ ìƒ‰ìƒ ì²˜ë¦¬
        let eventColor = shift.color || "#4285F4";
        let textColor = "#FFFFFF";

        // ë¯¸ë°°ì • ì‹œ ì—°í•œ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
        if (isUnassigned) {
          eventColor = "#E0E0E0"; // ì—°í•œ íšŒìƒ‰
          textColor = "#757575"; // ì–´ë‘ìš´ íšŒìƒ‰ í…ìŠ¤íŠ¸
        }
        // ì¸ì› ë¶€ì¡± ì‹œ ë¹¨ê°„ìƒ‰ ê²½ê³ 
        else if (isUnderStaffed) {
          eventColor = "#FFA726"; // ì£¼í™©ìƒ‰ (ê²½ê³ )
        }
        // ì¸ì› ì´ˆê³¼ ì‹œ ë…¸ë€ìƒ‰ ê²½ê³ 
        else if (isOverStaffed) {
          eventColor = "#FDD835"; // ë…¸ë€ìƒ‰ (ì£¼ì˜)
        }

        // ì‹œí”„íŠ¸ íƒ€ì…ì— ë”°ë¥¸ í‘œì‹œ
        const shiftType = shift.extendedProps?.shiftType || "middle";
        let prefix = "";

        if (shiftType === "open") {
          prefix = "â˜€ï¸ ";
        } else if (shiftType === "middle") {
          prefix = "ğŸ• ";
        } else if (shiftType === "close") {
          prefix = "ğŸŒ™ ";
        }

        // ì¸ì› ìƒíƒœ ì ‘ë¯¸ì‚¬
        let staffingSuffix = "";
        if (isUnassigned) {
          staffingSuffix = " (ë¯¸ë°°ì •)";
        } else if (isUnderStaffed) {
          staffingSuffix = ` (ì¸ì›ë¶€ì¡±: ${shift.employeeIds?.length}/${shift.extendedProps?.minStaff})`;
        } else if (isOverStaffed) {
          staffingSuffix = ` (ì¸ì›ì´ˆê³¼: ${shift.employeeIds?.length}/${shift.extendedProps?.maxStaff})`;
        }

        // ê·¼ë¬´ íƒ€ì´í‹€ ì§€ì •
        const title = shift.title
          ? `${prefix}${shift.title}${staffingSuffix}`
          : `${prefix}${
              shiftType === "open"
                ? "ì˜¤í”ˆ"
                : shiftType === "middle"
                ? "ë¯¸ë“¤"
                : "ë§ˆê°"
            }${staffingSuffix}`;

        return {
          id: shift.id,
          title: title,
          start: shift.start,
          end: shift.end,
          color: eventColor,
          textColor: textColor,
          borderColor: isUnassigned ? "#BDBDBD" : undefined,
          extendedProps: {
            ...shift.extendedProps,
            employeeIds: shift.employeeIds || [],
            employeeNames,
            isUnassigned,
            isUnderStaffed,
            isOverStaffed,
          },
        };
      });

      setEvents(processedEvents);
      return processedEvents;
    },
    [employees]
  );

  // ì•Œë°”ìƒ ì¶”ì²œ í•¨ìˆ˜ ì¶”ê°€
  const getRecommendedEmployees = useCallback(
    (shift: Shift) => {
      if (!employees || !shift.start || !shift.end) return [];

      const shiftStartTime = parseISO(shift.start);
      const shiftEndTime = parseISO(shift.end);
      const dayOfWeek = shiftStartTime.getDay();

      // ì¶”ì²œ ì§ì› ì ìˆ˜ ê³„ì‚°
      const recommendations = employees
        .filter((emp) => emp.status === "active") // í™œì„± ì§ì›ë§Œ
        .map((employee) => {
          // ê¸°ë³¸ ì ìˆ˜
          let score = 0;

          // 1. ê°€ìš©ì„± í™•ì¸ (ê°€ì¥ ì¤‘ìš”) - í•´ë‹¹ ìš”ì¼ê³¼ ì‹œê°„ì— ì¼í•  ìˆ˜ ìˆëŠ”ì§€
          const availability = employeeAvailability.find(
            (a) => a.employeeId === employee.id && a.dayOfWeek === dayOfWeek
          );

          if (availability) {
            const availStart = parse(
              availability.startTime,
              "HH:mm",
              new Date()
            );
            const availEnd = parse(availability.endTime, "HH:mm", new Date());

            // ê°€ìš© ì‹œê°„ ë‚´ì— ìˆìœ¼ë©´ ë†’ì€ ì ìˆ˜
            if (
              getHours(shiftStartTime) >= getHours(availStart) &&
              getHours(shiftEndTime) <= getHours(availEnd)
            ) {
              score += 50;
            } else if (
              // ì¼ë¶€ ê²¹ì¹˜ë©´ ë‚®ì€ ì ìˆ˜
              (getHours(shiftStartTime) >= getHours(availStart) &&
                getHours(shiftStartTime) < getHours(availEnd)) ||
              (getHours(shiftEndTime) > getHours(availStart) &&
                getHours(shiftEndTime) <= getHours(availEnd))
            ) {
              score += 20;
            }
          }

          // 2. ê·¼ë¬´ íŒ¨í„´ í™•ì¸ - ì´ ì‚¬ëŒì´ í•´ë‹¹ ì‹œê°„ëŒ€ì— ì¼í•œ ì ì´ ë§ì€ì§€
          const previousShifts = events.filter(
            (s) =>
              s.extendedProps?.employeeIds?.includes(employee.id) &&
              parseISO(s.start).getDay() === dayOfWeek
          );

          if (previousShifts.length > 0) {
            score += 10;
          }

          // 3. ìµœê·¼ ê·¼ë¬´ ì‹œê°„ - ê³¼ë„í•œ ê·¼ë¬´ ì—¬ë¶€ í™•ì¸
          const recentShifts = events.filter(
            (s) =>
              s.extendedProps?.employeeIds?.includes(employee.id) &&
              differenceInHours(new Date(), parseISO(s.start)) <= 168 // ì§€ë‚œ ì¼ì£¼ì¼
          );

          const totalHoursLastWeek = recentShifts.reduce((acc, s) => {
            return acc + differenceInHours(parseISO(s.end), parseISO(s.start));
          }, 0);

          // ê·¼ë¬´ ì‹œê°„ì´ ì ì„ìˆ˜ë¡ ì¶”ì²œ ì ìˆ˜ ë†’ìŒ (ê³¼ë¡œ ë°©ì§€)
          if (totalHoursLastWeek < 15) {
            score += 15;
          } else if (totalHoursLastWeek < 30) {
            score += 5;
          }

          // 4. í•´ë‹¹ ì‹œê°„ëŒ€(ì˜¤í”ˆ/ë¯¸ë“¤/ë§ˆê°) ì„ í˜¸ë„ í™•ì¸
          const shiftsOfSameType = events.filter(
            (s) =>
              s.extendedProps?.employeeIds?.includes(employee.id) &&
              s.extendedProps?.shiftType === shift.extendedProps?.shiftType
          );

          if (shiftsOfSameType.length > 3) {
            score += 10; // ì´ ìœ í˜•ì˜ ì‹œê°„ëŒ€ì— ìì£¼ ì¼í•œ ì§ì›
          }

          return {
            employee,
            score,
            availabilityMatch: availability ? true : false,
            recentHours: totalHoursLastWeek,
          };
        });

      // ì ìˆ˜ì— ë”°ë¼ ì •ë ¬
      return recommendations.sort((a, b) => b.score - a.score);
    },
    [employees, employeeAvailability, events]
  );

  // ì•Œë°”ìƒ ì¶”ì²œ ëŒ€í™”ìƒì ìƒíƒœ ì¶”ê°€
  const [isRecommendationDialogOpen, setIsRecommendationDialogOpen] =
    useState(false);
  const [selectedShiftForRecommendation, setSelectedShiftForRecommendation] =
    useState<Shift | null>(null);
  const [recommendedEmployees, setRecommendedEmployees] = useState<any[]>([]);

  // ì¶”ì²œ ëŒ€í™”ìƒì ì—´ê¸° í•¨ìˆ˜
  const openRecommendationDialog = (shift: Shift) => {
    setSelectedShiftForRecommendation(shift);
    const recommendations = getRecommendedEmployees(shift);
    setRecommendedEmployees(recommendations);
    setIsRecommendationDialogOpen(true);
  };

  // ì¶”ì²œëœ ì•Œë°”ìƒ ë°°ì • í•¨ìˆ˜
  const assignRecommendedEmployee = (employeeId: string) => {
    if (!selectedShiftForRecommendation) return;

    // ê¸°ì¡´ ê·¼ë¬´ ë³µì œ
    const updatedShift = { ...selectedShiftForRecommendation };

    // ì§ì› ID ì¶”ê°€
    if (!updatedShift.employeeIds) {
      updatedShift.employeeIds = [];
    }

    // ì´ë¯¸ ë°°ì •ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
    if (!updatedShift.employeeIds.includes(employeeId)) {
      updatedShift.employeeIds.push(employeeId);

      // API í˜¸ì¶œí•˜ì—¬ ì €ì¥
      saveShift(updatedShift)
        .then(() => {
          // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ëœ í›„ UI ì—…ë°ì´íŠ¸
          // ì§ì ‘ ì´ë²¤íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
          const updatedEvents = events.map((event) => {
            if (event.id === updatedShift.id) {
              // ì„ íƒí•œ ì§ì› ì¶”ê°€
              const updatedEmployeeIds = [
                ...(event.extendedProps?.employeeIds || []),
                employeeId,
              ];

              // ì„ íƒí•œ ì§ì› ì´ë¦„ ì°¾ê¸°
              const employeeName =
                employees.find((e) => e.id === employeeId)?.name || "";
              const updatedEmployeeNames = [
                ...(event.extendedProps?.employeeNames || []),
                employeeName,
              ];

              // ê·¼ë¬´ ìƒíƒœ ì—…ë°ì´íŠ¸
              let status: "unassigned" | "assigned" | "substitute-requested" =
                "assigned";
              if (updatedEmployeeIds.length === 0) {
                status = "unassigned";
              } else if (event.extendedProps?.isSubstituteRequest) {
                status = "substitute-requested";
              }

              return {
                ...event,
                extendedProps: {
                  ...event.extendedProps,
                  employeeIds: updatedEmployeeIds,
                  employeeNames: updatedEmployeeNames,
                  status,
                  isUnassigned: updatedEmployeeIds.length === 0,
                },
              };
            }
            return event;
          });

          setEvents(updatedEvents);
          console.log("ê·¼ë¬´ ë°°ì • ì™„ë£Œ - ì´ë²¤íŠ¸ ìƒíƒœ ê°±ì‹ ë¨");
          setIsRecommendationDialogOpen(false);
        })
        .catch((err) => {
          console.error("ê·¼ë¬´ ë°°ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
          alert("ê·¼ë¬´ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }
  };

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  if (loading) {
    return (
      <Box
        sx={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          height: "80vh",
          flexDirection: "column",
          gap: 2,
        }}
      >
        <CircularProgress size={60} thickness={4} />
        <Typography variant="h6">ìŠ¤ì¼€ì¤„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</Typography>
        <Typography variant="body2" color="text.secondary">
          ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì²« ë¡œë”©ì€ ì‹œê°„ì´ ì¡°ê¸ˆ ë” ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </Typography>
      </Box>
    );
  }

  // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
  if (error) {
    return (
      <Box sx={{ p: 3 }}>
        <Alert severity="error" sx={{ mb: 2 }}>
          {error}
        </Alert>
        <Typography variant="body1" sx={{ mb: 2 }}>
          ìŠ¤ì¼€ì¤„ í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼
          ì‹œë„í•´ë³´ì„¸ìš”:
        </Typography>
        <List>
          <ListItem>
            <ListItemText
              primary="í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨"
              secondary="ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ë¹„ìš°ê³  ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤."
            />
            <Button
              variant="outlined"
              onClick={() => window.location.reload()}
              size="small"
            >
              ìƒˆë¡œê³ ì¹¨
            </Button>
          </ListItem>
          {error.includes("ë§¤ì¥ ì •ë³´") && (
            <ListItem>
              <ListItemText
                primary="ì§€ì  ì„¤ì •ìœ¼ë¡œ ì´ë™"
                secondary="ë§¤ì¥ ì •ë³´ë¥¼ ì„¤ì •í•´ì•¼ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
              />
              <Button
                variant="contained"
                color="primary"
                onClick={() => navigate("/settings")}
                startIcon={<SettingsIcon />}
                size="small"
              >
                ì„¤ì •ìœ¼ë¡œ ì´ë™
              </Button>
            </ListItem>
          )}
        </List>
      </Box>
    );
  }

  // í…œí”Œë¦¿ ë©”ë‰´ ì»´í¬ë„ŒíŠ¸
  const renderTemplateMenu = () => (
    <Menu
      anchorEl={anchorEl}
      open={Boolean(anchorEl)}
      onClose={handleCloseTemplateMenu}
      anchorOrigin={{
        vertical: "bottom",
        horizontal: "left",
      }}
    >
      <Typography variant="subtitle2" sx={{ px: 2, py: 1, fontWeight: 600 }}>
        ê·¼ë¬´ í…œí”Œë¦¿ ì„ íƒ
      </Typography>
      <Divider />
      {shiftTemplates.map((template) => (
        <MenuItem
          key={template.id}
          onClick={() => handleCreateShiftFromTemplate(template)}
          sx={{
            "&:hover": { backgroundColor: `${template.color}22` },
          }}
        >
          <Box
            sx={{
              width: 14,
              height: 14,
              borderRadius: "50%",
              backgroundColor: template.color,
              mr: 1,
            }}
          />
          <Typography variant="body2">
            {template.name} ({template.startTime} - {template.endTime})
            {template.requiredStaff > 1 && ` - ${template.requiredStaff}ëª…`}
          </Typography>
        </MenuItem>
      ))}
      <Divider />
      <MenuItem onClick={handleCloseTemplateMenu}>
        <Typography variant="body2" color="text.secondary">
          ì·¨ì†Œ
        </Typography>
      </MenuItem>
    </Menu>
  );

  // ì¶”ì²œ ëŒ€í™”ìƒì ì»´í¬ë„ŒíŠ¸
  const EmployeeRecommendationDialog = () => {
    if (!selectedShiftForRecommendation) return null;

    const shiftStart = parseISO(selectedShiftForRecommendation.start);
    const shiftEnd = parseISO(selectedShiftForRecommendation.end);
    const formattedDate = format(shiftStart, "yyyyë…„ MMì›” ddì¼");
    const formattedTime = `${format(shiftStart, "HH:mm")} - ${format(
      shiftEnd,
      "HH:mm"
    )}`;

    const shiftType =
      selectedShiftForRecommendation.extendedProps?.shiftType || "middle";
    const shiftTitle =
      shiftType === "open" ? "ì˜¤í”ˆ" : shiftType === "middle" ? "ë¯¸ë“¤" : "ë§ˆê°";

    return (
      <Dialog
        open={isRecommendationDialogOpen}
        onClose={() => setIsRecommendationDialogOpen(false)}
        maxWidth="md"
        fullWidth
      >
        <DialogTitle>
          <Box
            sx={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
            }}
          >
            <Typography variant="h6">ì•Œë°”ìƒ ì¶”ì²œ</Typography>
          </Box>
        </DialogTitle>

        <DialogContent>
          <Box
            sx={{ mb: 2, p: 2, bgcolor: "background.default", borderRadius: 1 }}
          >
            <Typography variant="subtitle1" gutterBottom>
              {formattedDate} {shiftTitle} ê·¼ë¬´ ({formattedTime})
            </Typography>
            <Typography variant="body2" color="text.secondary">
              {selectedShiftForRecommendation.extendedProps?.isUnassigned
                ? "ì´ ê·¼ë¬´ì— ë°°ì •ëœ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤."
                : `í˜„ì¬ ${
                    selectedShiftForRecommendation.employeeIds?.length || 0
                  }ëª… ë°°ì •ë¨ (ìµœì†Œ í•„ìš”: ${
                    selectedShiftForRecommendation.extendedProps?.minStaff || 1
                  }ëª…)`}
            </Typography>
          </Box>

          <Divider sx={{ mb: 2 }} />

          <Typography variant="subtitle2" gutterBottom>
            ì¶”ì²œ ì•Œë°”ìƒ
          </Typography>

          {recommendedEmployees.length === 0 ? (
            <Alert severity="info">
              ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤. ì§ì›ì˜ ê°€ìš© ì‹œê°„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            </Alert>
          ) : (
            <TableContainer component={Paper} variant="outlined">
              <Table size="small">
                <TableHead>
                  <TableRow sx={{ bgcolor: "background.default" }}>
                    <TableCell>ì´ë¦„</TableCell>
                    <TableCell align="center">ê°€ìš© ì‹œê°„</TableCell>
                    <TableCell align="center">ìµœê·¼ ê·¼ë¬´</TableCell>
                    <TableCell align="center">ì¶”ì²œ ì ìˆ˜</TableCell>
                    <TableCell align="right">ë°°ì •</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {recommendedEmployees.map((rec) => {
                    // ì´ë¯¸ ì´ ê·¼ë¬´ì— ë°°ì •ëœ ì§ì›ì¸ì§€ í™•ì¸
                    const isAlreadyAssigned =
                      selectedShiftForRecommendation.employeeIds?.includes(
                        rec.employee.id
                      );

                    return (
                      <TableRow key={rec.employee.id} hover>
                        <TableCell>{rec.employee.name}</TableCell>
                        <TableCell align="center">
                          {rec.availabilityMatch ? (
                            <Chip
                              label="ì‹œê°„ ê°€ëŠ¥"
                              size="small"
                              color="success"
                              variant="outlined"
                            />
                          ) : (
                            <Chip
                              label="ì‹œê°„ ì œì•½"
                              size="small"
                              color="warning"
                              variant="outlined"
                            />
                          )}
                        </TableCell>
                        <TableCell align="center">
                          {rec.recentHours}ì‹œê°„/ì£¼
                        </TableCell>
                        <TableCell align="center">
                          <Box
                            sx={{
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                            }}
                          >
                            <Box
                              sx={{
                                width: `${Math.min(100, rec.score)}%`,
                                bgcolor: theme.palette.primary.main,
                                height: 8,
                                borderRadius: 4,
                              }}
                            />
                            <Typography variant="caption" sx={{ ml: 1 }}>
                              {rec.score}
                            </Typography>
                          </Box>
                        </TableCell>
                        <TableCell align="right">
                          {isAlreadyAssigned ? (
                            <Chip label="ë°°ì •ë¨" size="small" color="primary" />
                          ) : (
                            <Button
                              variant="contained"
                              color="primary"
                              size="small"
                              onClick={() =>
                                assignRecommendedEmployee(rec.employee.id)
                              }
                            >
                              ë°°ì •
                            </Button>
                          )}
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </DialogContent>

        <DialogActions>
          <Button
            onClick={() => setIsRecommendationDialogOpen(false)}
            color="inherit"
          >
            ë‹«ê¸°
          </Button>
        </DialogActions>
      </Dialog>
    );
  };

  return (
    <>
      {/* í…œí”Œë¦¿ ë©”ë‰´ ë Œë”ë§ */}
      {renderTemplateMenu()}

      {/* í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ ì¶”ê°€ */}
      <TemplateManagerDialog
        open={isTemplateManagerOpen}
        onClose={() => {
          setIsTemplateManagerOpen(false);
          // ìµœì‹  í…œí”Œë¦¿ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œ
          loadTemplatesFromStorage();
        }}
        templates={shiftTemplates}
        onSaveTemplates={handleSaveTemplates}
      />

      {/* ì•Œë°”ìƒ ì¶”ì²œ ëŒ€í™”ìƒì ì¶”ê°€ */}
      <EmployeeRecommendationDialog />

      <Box
        sx={{
          display: "flex",
          height: "calc(100vh - 64px)",
          position: "relative",
          overflow: "hidden",
          backgroundColor: "#f9fafb",
        }}
      >
        {/* ì™¼ìª½ ì‚¬ì´ë“œíŒ¨ë„ (í•„í„°, ì•Œë°”ìƒ ëª©ë¡ ë“±) */}
        <Drawer
          variant={isMobile ? "temporary" : "persistent"}
          anchor="left"
          open={showSidePanel}
          onClose={() => setShowSidePanel(false)}
          PaperProps={{
            sx: {
              width: 280,
              position: "static",
              height: "100%",
              borderRight: "none",
              boxShadow: showSidePanel ? theme.shadows[2] : "none",
              marginLeft: 0,
              marginRight: 1.5, // ìº˜ë¦°ë”ì™€ì˜ ì—¬ë°± ì¶”ê°€
            },
          }}
          sx={{
            width: showSidePanel ? 280 : 0,
            flexShrink: 0,
            transition: "width 0.3s ease",
            "& .MuiDrawer-paper": {
              width: 280,
              boxSizing: "border-box",
              height: "100%",
              overflow: "auto",
              position: "relative",
              backgroundColor: "background.paper",
              boxShadow: "none",
              zIndex: theme.zIndex.drawer,
            },
          }}
        >
          <Box sx={{ p: 2 }}>
            <Typography variant="h6" gutterBottom>
              ìŠ¤ì¼€ì¤„ ê´€ë¦¬
            </Typography>

            {/* ê°€ëŠ¥ ì‹œê°„ í•„í„° */}
            <Box sx={{ my: 2 }}>
              <Typography variant="subtitle2" gutterBottom>
                <FilterAlt
                  fontSize="small"
                  sx={{ verticalAlign: "middle", mr: 0.5 }}
                />
                ê°€ëŠ¥ ì‹œê°„ í•„í„°
              </Typography>

              <Grid container spacing={1} sx={{ mb: 1 }}>
                <Grid item xs={5}>
                  <TextField
                    label="ì‹œì‘"
                    type="time"
                    size="small"
                    fullWidth
                    value={availabilityFilter?.start || "09:00"}
                    onChange={(e) =>
                      handleAvailabilityFilterChange("start", e.target.value)
                    }
                    InputLabelProps={{ shrink: true }}
                  />
                </Grid>
                <Grid item xs={2} sx={{ textAlign: "center", pt: 2 }}>
                  <Typography variant="body2">~</Typography>
                </Grid>
                <Grid item xs={5}>
                  <TextField
                    label="ì¢…ë£Œ"
                    type="time"
                    size="small"
                    fullWidth
                    value={availabilityFilter?.end || "18:00"}
                    onChange={(e) =>
                      handleAvailabilityFilterChange("end", e.target.value)
                    }
                    InputLabelProps={{ shrink: true }}
                  />
                </Grid>
              </Grid>

              <Box sx={{ mb: 2, display: "flex", justifyContent: "flex-end" }}>
                <Button size="small" onClick={resetFilters} variant="outlined">
                  í•„í„° ì´ˆê¸°í™”
                </Button>
              </Box>
            </Box>

            <Divider sx={{ my: 2 }} />

            {/* ë¯¸ë°°ì • ê·¼ë¬´ë§Œ ë³´ê¸° */}
            <FormControlLabel
              control={
                <Checkbox
                  checked={showUnassignedOnly}
                  onChange={(e) => setShowUnassignedOnly(e.target.checked)}
                  size="small"
                />
              }
              label={
                <Typography variant="body2">ë¯¸ë°°ì • ê·¼ë¬´ë§Œ ë³´ê¸°</Typography>
              }
            />

            <Divider sx={{ my: 2 }} />

            {/* ì•Œë°”ìƒ í•„í„° */}
            <Typography variant="subtitle2" gutterBottom>
              <PersonAdd
                fontSize="small"
                sx={{ verticalAlign: "middle", mr: 0.5 }}
              />
              ì•Œë°”ìƒ í•„í„°
            </Typography>
            <List sx={{ pt: 0 }}>
              {employees.map((employee) => (
                <ListItem key={employee.id} disablePadding>
                  <ListItemButton
                    dense
                    onClick={() => handleEmployeeFilter(employee.id)}
                    selected={filteredEmployeeIds.includes(employee.id)}
                  >
                    <ListItemIcon sx={{ minWidth: 36 }}>
                      <Box
                        sx={{
                          width: 12,
                          height: 12,
                          borderRadius: "50%",
                          bgcolor: getEmployeeColor(employee.id),
                        }}
                      />
                    </ListItemIcon>
                    <ListItemText
                      primary={employee.name}
                      primaryTypographyProps={{ variant: "body2" }}
                      secondary={employee.role || "ì¼ë°˜ ê·¼ë¬´ì"}
                      secondaryTypographyProps={{ variant: "caption" }}
                    />
                  </ListItemButton>
                </ListItem>
              ))}
            </List>
            {employees.length === 0 && (
              <Alert severity="info" sx={{ mt: 1 }}>
                ë“±ë¡ëœ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤
                <Button
                  variant="text"
                  size="small"
                  onClick={handleGoToEmployees}
                  sx={{ ml: 1 }}
                >
                  ì•Œë°”ìƒ ë“±ë¡
                </Button>
              </Alert>
            )}

            <Divider sx={{ my: 2 }} />

            {/* ë¯¸ë°°ì • ê·¼ë¬´ ë¸”ë¡ ëª©ë¡ */}
            <Typography variant="subtitle2" gutterBottom>
              <Assignment
                fontSize="small"
                sx={{ verticalAlign: "middle", mr: 0.5 }}
              />
              ë¯¸ë°°ì • ê·¼ë¬´ ({unassignedShifts.length})
            </Typography>

            {unassignedShifts.length > 0 ? (
              <List sx={{ pt: 0 }}>
                {unassignedShifts.map((shift) => (
                  <ListItem
                    key={shift.id}
                    sx={{
                      bgcolor: "grey.100",
                      borderRadius: 1,
                      mb: 1,
                      p: 1,
                    }}
                  >
                    <ListItemText
                      primary={format(new Date(shift.start), "M.d (eee) HH:mm")}
                      secondary={format(new Date(shift.end), "HH:mm")}
                      secondaryTypographyProps={{ variant: "caption" }}
                    />
                    <IconButton
                      size="small"
                      onClick={() => {
                        setSelectedEvent(shift);
                        setIsNewEvent(false);
                        setIsDialogOpen(true);
                      }}
                    >
                      <AssignmentInd fontSize="small" />
                    </IconButton>
                  </ListItem>
                ))}
              </List>
            ) : (
              <Alert severity="success" sx={{ mt: 1 }}>
                ëª¨ë“  ê·¼ë¬´ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
              </Alert>
            )}

            <Divider sx={{ my: 2 }} />

            {/* ëŒ€íƒ€ ìš”ì²­ ëª©ë¡ */}
            <Typography variant="subtitle2" gutterBottom>
              <AssignmentLate
                fontSize="small"
                sx={{ verticalAlign: "middle", mr: 0.5 }}
              />
              ëŒ€íƒ€ ìš”ì²­ ({substituteRequestShifts.length})
            </Typography>

            {substituteRequestShifts.length > 0 ? (
              <List sx={{ pt: 0 }}>
                {substituteRequestShifts.map((shift) => (
                  <ListItem
                    key={shift.id}
                    sx={{
                      bgcolor: shift.extendedProps?.isHighPriority
                        ? "error.light"
                        : "warning.light",
                      borderRadius: 1,
                      mb: 1,
                      p: 1,
                    }}
                  >
                    <ListItemText
                      primary={
                        <Box sx={{ display: "flex", alignItems: "center" }}>
                          {shift.extendedProps?.isHighPriority && (
                            <NotificationsActive
                              fontSize="small"
                              color="error"
                              sx={{ mr: 0.5 }}
                            />
                          )}
                          <Typography variant="body2">
                            {format(new Date(shift.start), "M.d (eee) HH:mm")}
                          </Typography>
                        </Box>
                      }
                      secondary={
                        <Box>
                          <Typography variant="caption" display="block">
                            {format(new Date(shift.end), "HH:mm")}
                          </Typography>
                          <Typography variant="caption" display="block">
                            {shift.extendedProps?.employeeNames?.[0]}
                          </Typography>
                        </Box>
                      }
                    />
                    <IconButton
                      size="small"
                      onClick={() => {
                        setSelectedEvent(shift);
                        setIsNewEvent(false);
                        setIsDialogOpen(true);
                      }}
                    >
                      <MoreVert fontSize="small" />
                    </IconButton>
                  </ListItem>
                ))}
              </List>
            ) : (
              <Alert severity="success" sx={{ mt: 1 }}>
                ëŒ€íƒ€ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
              </Alert>
            )}
          </Box>
        </Drawer>

        {/* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ìº˜ë¦°ë”) */}
        <Box
          sx={{
            flexGrow: 1,
            p: 0,
            height: "100%",
            overflow: "auto",
            width: {
              xs: "100%",
              sm: `calc(100% - ${showSidePanel ? "282px" : "0px"})`, // 1.5rem ì—¬ë°± í¬í•¨
            },
            ml: showSidePanel ? 0 : { xs: 0, sm: 2 }, // ì‚¬ì´ë“œíŒ¨ë„ ë‹«í ë•Œ ì™¼ìª½ ì—¬ë°± ì¶”ê°€
            backgroundColor: "white",
            borderRadius: showSidePanel ? 0 : "8px 0 0 0",
            boxShadow: showSidePanel ? "none" : theme.shadows[1],
            transition:
              "width 0.3s ease, margin-left 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease",
          }}
        >
          {/* ìƒë‹¨ ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
          <Box
            sx={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              p: 2,
              borderBottom: "1px solid rgba(0, 0, 0, 0.08)",
              flexWrap: { xs: "wrap", sm: "nowrap" },
              gap: 1,
              background: showSidePanel
                ? "linear-gradient(90deg, rgba(249,250,251,1) 0%, rgba(255,255,255,1) 100%)"
                : "white",
              transition: "background 0.3s ease",
              height: "56px",
            }}
          >
            <ToggleButtonGroup
              value={viewType}
              exclusive
              onChange={handleViewChange}
              size={isMobile ? "small" : "medium"}
              aria-label="ìº˜ë¦°ë” ë³´ê¸° ë°©ì‹"
              sx={{
                "& .MuiToggleButton-root": {
                  px: { xs: 1.5, sm: 2 },
                  borderColor: "rgba(0, 0, 0, 0.08)",
                  "&.Mui-selected": {
                    backgroundColor: theme.palette.primary.main,
                    color: "white",
                    "&:hover": {
                      backgroundColor: theme.palette.primary.dark,
                    },
                  },
                },
              }}
            >
              <ToggleButton value="timeGridWeek">
                <ViewWeek fontSize="small" sx={{ mr: isMobile ? 0.5 : 1 }} />
                {!isMobile && "ì£¼ê°„"}
              </ToggleButton>
              <ToggleButton value="dayGridMonth">
                <CalendarMonth
                  fontSize="small"
                  sx={{ mr: isMobile ? 0.5 : 1 }}
                />
                {!isMobile && "ì›”ê°„"}
              </ToggleButton>
            </ToggleButtonGroup>

            <Box sx={{ display: "flex", gap: 1 }}>
              {/* í…œí”Œë¦¿ ê´€ë¦¬ ë²„íŠ¼ ì¶”ê°€ */}
              <Button
                variant="contained"
                color="primary"
                size="small"
                startIcon={<SettingsIcon />}
                onClick={() => setIsTemplateManagerOpen(true)}
                sx={{
                  borderRadius: "20px",
                  px: 2,
                  transition: "all 0.2s ease",
                }}
              >
                {isMobile ? "í…œí”Œë¦¿" : "í…œí”Œë¦¿ ê´€ë¦¬"}
              </Button>

              <Button
                variant="outlined"
                color="primary"
                size="small"
                startIcon={showSidePanel ? <AccessTime /> : <FilterAlt />}
                onClick={() => setShowSidePanel(!showSidePanel)}
                sx={{
                  borderRadius: "20px",
                  px: 2,
                  transition: "all 0.2s ease",
                  borderColor: "rgba(0, 0, 0, 0.12)",
                  "&:hover": {
                    borderColor: theme.palette.primary.main,
                    backgroundColor: "rgba(25, 118, 210, 0.04)",
                  },
                }}
              >
                {isMobile ? (
                  <>{showSidePanel ? "ë‹«ê¸°" : "í•„í„°"}</>
                ) : (
                  <>{showSidePanel ? "ì‚¬ì´ë“œíŒ¨ë„ ë‹«ê¸°" : "ì‚¬ì´ë“œíŒ¨ë„ ì—´ê¸°"}</>
                )}
              </Button>
            </Box>
          </Box>

          {/* í° í…œí”Œë¦¿ ê´€ë¦¬ ë²„íŠ¼ ì¶”ê°€ */}
          <Box
            sx={{
              display: "flex",
              justifyContent: "center",
              p: 2,
              backgroundColor: "#f5f5f5",
              borderBottom: "1px solid #e0e0e0",
            }}
          >
            <Button
              variant="contained"
              color="secondary"
              size="large"
              startIcon={<SettingsIcon />}
              onClick={() => setIsTemplateManagerOpen(true)}
              sx={{
                borderRadius: "8px",
                px: 4,
                py: 1,
                fontSize: "1rem",
                fontWeight: "bold",
              }}
            >
              ê·¼ë¬´ í…œí”Œë¦¿ ê´€ë¦¬
            </Button>
          </Box>

          {/* ìº˜ë¦°ë” */}
          <Paper
            elevation={0}
            sx={{
              height: "calc(100% - 56px)",
              width: "100%",
              display: "flex",
              flexDirection: "column",
              border: "none",
              borderRadius: 0,
              "& .fc": {
                height: "100%",
                width: "100%",
                fontFamily: theme.typography.fontFamily,
              },
              "& .fc-toolbar-title": {
                fontSize: { xs: "1rem", sm: "1.25rem" },
                fontWeight: 500,
                color: theme.palette.text.primary,
              },
              "& .fc-header-toolbar": {
                padding: "0.75rem 1.25rem",
                marginBottom: "0.5rem !important",
              },
              "& .fc-view-harness": {
                flex: 1,
                minHeight: 0,
                height: "calc(100% - 60px) !important", // ê³ ì • ë†’ì´ ì§€ì •
                position: "relative",
              },
              "& .fc-scroller": {
                height: "auto !important", // ìë™ ë†’ì´ë¡œ ìˆ˜ì •
                overflow: "hidden auto", // ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€
              },
              "& .fc-view": {
                width: "100%", // ë·° ë„ˆë¹„ ìµœëŒ€í™”
                height: "auto !important", // ë†’ì´ ìë™ ì¡°ì •
                overflow: "visible", // ì˜¤ë²„í”Œë¡œìš° ë³´ì´ê¸°
              },
              "& .fc-event": {
                cursor: "pointer",
                borderRadius: "4px",
                boxShadow: "0 1px 2px rgba(0,0,0,0.05)",
                margin: "2px 1px",
                padding: "1px 3px",
                fontSize: "0.75rem", // í°íŠ¸ í¬ê¸° ì¶•ì†Œ
              },
              "& .fc-theme-standard .fc-scrollgrid": {
                border: "1px solid rgba(0, 0, 0, 0.08)",
              },
              "& .fc-theme-standard td, & .fc-theme-standard th": {
                borderColor: "rgba(0, 0, 0, 0.08)",
              },
              "& .fc-event-unassigned": {
                backgroundColor: "#E0E0E0",
                borderColor: "#9E9E9E",
              },
              "& .fc-event-substitute-requested": {
                borderLeft: "4px solid orange",
              },
              "& .fc-event-high-priority": {
                borderLeft: "4px solid red",
                animation: "pulse 1.5s infinite",
              },
              "& .fc .fc-dayGridMonth-view .fc-daygrid-body": {
                height: "auto !important",
              },
              "& .fc-day": {
                backgroundColor: "white",
              },
              "& .fc-day-today": {
                backgroundColor: "rgba(66, 133, 244, 0.05) !important",
              },
              "& .fc-col-header-cell": {
                backgroundColor: "rgba(0, 0, 0, 0.02)",
                padding: showSidePanel ? "6px 0" : "8px 0", // ì‚¬ì´ë“œíŒ¨ë„ ìƒíƒœì— ë”°ë¼ íŒ¨ë”© ì¡°ì •
                borderBottom: "1px solid rgba(0, 0, 0, 0.08)",
                transition: "padding 0.3s ease",
              },
              "& .fc-col-header-cell-cushion": {
                padding: showSidePanel ? "8px 2px" : "12px 4px", // ì‚¬ì´ë“œíŒ¨ë„ ìƒíƒœì— ë”°ë¼ íŒ¨ë”© ì¡°ì •
                fontWeight: "bold",
                color: theme.palette.text.primary,
                textDecoration: "none !important",
                transition: "padding 0.3s ease",
              },
              "& .fc-col-header-cell.fc-day-sun .fc-col-header-cell-cushion": {
                color: "#E74C3C",
              },
              "& .fc-col-header-cell.fc-day-sat .fc-col-header-cell-cushion": {
                color: "#3498DB",
              },
              "& .fc-day-today .fc-col-header-cell-cushion": {
                backgroundColor: theme.palette.primary.main,
                color: "white",
                padding: "4px 8px",
                borderRadius: "12px",
                display: "inline-block",
              },
              "& .fc-scrollgrid": {
                border: "1px solid rgba(0, 0, 0, 0.08) !important",
                borderRadius: 0,
              },
              "& .fc-scrollgrid-section-header": {
                border: "none",
              },
              "& .fc-timegrid-slots": {
                borderTop: "1px solid rgba(0, 0, 0, 0.08)",
              },
              "& .fc-timegrid-slot": {
                height: showSidePanel ? "22px !important" : "28px !important", // ì‚¬ì´ë“œíŒ¨ë„ ìƒíƒœì— ë”°ë¼ ë†’ì´ ì¡°ì •
                borderColor: "rgba(0, 0, 0, 0.05)",
                transition: "height 0.3s ease",
              },
              "& .fc-timegrid-slot-lane": {
                borderColor: "rgba(0, 0, 0, 0.05)",
              },
              "& .fc-timegrid-slot-minor": {
                borderColor: "rgba(0, 0, 0, 0.03)",
              },
              "& .fc-timegrid-col-frame": {
                minWidth: showSidePanel ? "90px" : "150px", // ì‚¬ì´ë“œíŒ¨ë„ ë‹«í ë•Œ ë” ë„“ê²Œ
                transition: "min-width 0.3s ease",
              },
              "& .fc-timegrid-cols": {
                width: "100% !important",
                height: "100% !important", // ë†’ì´ ìµœëŒ€í™”
              },
              "& .fc-timegrid-col": {
                width: `calc(100% / 7) !important`, // 7ì¼ í‘œì‹œë¥¼ ìœ„í•œ ê· ë“± ë„ˆë¹„
                minWidth: showSidePanel ? "90px" : "150px", // ì‚¬ì´ë“œíŒ¨ë„ ë‹«í ë•Œ ë” ë„“ê²Œ
                transition: "min-width 0.3s ease",
              },
              "& .fc-timegrid-axis": {
                borderRight: "1px solid rgba(0, 0, 0, 0.08)",
                padding: "0 8px",
                display: "flex",
                alignItems: "center",
                justifyContent: "flex-end",
                width: "65px !important", // ê³ ì • ë„ˆë¹„ë¡œ ì„¤ì •
              },
              "& .fc-timegrid-slot-label": {
                fontSize: "0.75rem",
                color: theme.palette.text.secondary,
                borderColor: "rgba(0, 0, 0, 0.05)",
              },
              "& .fc-timegrid-slot-label-cushion": {
                fontSize: "0.75rem",
                fontWeight: 500,
              },
              "& .fc-day-header": {
                fontWeight: "bold",
                textAlign: "center",
                padding: "4px 0",
                fontSize: "0.9rem",
                lineHeight: 1.2,
              },
              "@media (max-width: 600px)": {
                "& .fc-toolbar": {
                  flexDirection: "column",
                  gap: "10px",
                  padding: "0.5rem",
                },
                "& .fc-toolbar-title": {
                  fontSize: "1rem",
                },
                "& .fc-col-header-cell-cushion": {
                  padding: "8px 2px",
                },
                "& .fc-timegrid-col-frame": {
                  minWidth: "70px",
                },
                "& .fc-timegrid-col": {
                  minWidth: "70px",
                },
              },
            }}
          >
            <ErrorBoundary
              fallback={
                <Box
                  sx={{
                    height: "100%",
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "center",
                    alignItems: "center",
                    p: 3,
                  }}
                >
                  <Alert severity="error" sx={{ mb: 2, width: "100%" }}>
                    ìº˜ë¦°ë” ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                  </Alert>
                  <Button
                    variant="contained"
                    onClick={() => window.location.reload()}
                    startIcon={<SettingsIcon />}
                  >
                    í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                  </Button>
                </Box>
              }
            >
              {/* ìº˜ë¦°ë” ì»´í¬ë„ŒíŠ¸ë¥¼ Suspenseë¡œ ê°ì‹¸ê¸° */}
              <Suspense
                fallback={
                  <Box
                    sx={{
                      display: "flex",
                      justifyContent: "center",
                      alignItems: "center",
                      height: "100%",
                    }}
                  >
                    <CircularProgress size={40} thickness={4} />
                  </Box>
                }
              >
                {/* ë¶„ë¦¬ëœ ìº˜ë¦°ë” ì»´í¬ë„ŒíŠ¸ë¡œ êµì²´ */}
                <ScheduleCalendar
                  calendarRef={calendarRef}
                  viewType={viewType}
                  events={filteredEvents}
                  isMobile={isMobile}
                  showSidePanel={showSidePanel}
                  theme={theme}
                  onDateSelect={handleDateSelect}
                  onEventClick={handleEventClick}
                  onEventDrop={handleEventDrop}
                  onEventResize={handleEventResize}
                  renderEventContent={renderEventContent}
                />
              </Suspense>
            </ErrorBoundary>
          </Paper>
        </Box>
      </Box>

      {/* ê·¼ë¬´ ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ */}
      {isDialogOpen && selectedEvent && (
        <ShiftDialog
          eventData={selectedEvent}
          isNew={isNewEvent}
          employees={employees}
          onClose={handleCloseDialog}
          onSave={handleSaveShift}
          onSubstituteRequest={handleSubstituteRequest}
          onOpenTemplateManager={() => setIsTemplateManagerOpen(true)}
        />
      )}

      {/* ìº˜ë¦°ë” ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ */}
      <Box
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          mb: 2,
          p: 1,
          bgcolor: "background.paper",
          borderRadius: 1,
          boxShadow: 1,
        }}
      >
        {/* ì¢Œì¸¡ ë²„íŠ¼ ì˜ì—­ */}
        <Box sx={{ display: "flex", gap: 1 }}>
          <ToggleButtonGroup
            value={viewType}
            exclusive
            onChange={handleViewChange}
            size="small"
          >
            <ToggleButton value="timeGridWeek">
              <ViewWeek fontSize="small" sx={{ mr: 0.5 }} />
              ì£¼ê°„
            </ToggleButton>
            <ToggleButton value="dayGridMonth">
              <CalendarMonth fontSize="small" sx={{ mr: 0.5 }} />
              ì›”ê°„
            </ToggleButton>
          </ToggleButtonGroup>
        </Box>

        {/* ì¤‘ì•™ ì˜ì—­ - ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ */}
        <Box>
          <Button
            variant="outlined"
            color="primary"
            size="small"
            startIcon={showSidePanel ? <AccessTime /> : <FilterAlt />}
            onClick={() => setShowSidePanel(!showSidePanel)}
          >
            {showSidePanel ? "ì‚¬ì´ë“œíŒ¨ë„ ë‹«ê¸°" : "ì‚¬ì´ë“œíŒ¨ë„ ì—´ê¸°"}
          </Button>
        </Box>

        {/* ìš°ì¸¡ ë²„íŠ¼ ì˜ì—­ - í…œí”Œë¦¿ ê´€ë¦¬ ë²„íŠ¼ ê°•ì¡° */}
        <Box sx={{ display: "flex", gap: 1 }}>
          <Button
            variant="contained"
            color="primary"
            startIcon={<SettingsIcon />}
            onClick={() => setIsTemplateManagerOpen(true)}
            sx={{
              borderRadius: "4px",
              boxShadow: 2,
              fontWeight: "bold",
            }}
          >
            ê·¼ë¬´ í…œí”Œë¦¿ ê´€ë¦¬
          </Button>
        </Box>
      </Box>

      {/* ì¶”ê°€ ì•ˆë‚´ ë¬¸êµ¬ - ì²« ë°©ë¬¸ì‹œë§Œ í‘œì‹œë˜ë„ë¡ ì„¤ì • ê°€ëŠ¥ */}
      <Alert
        severity="info"
        sx={{ mb: 2 }}
        action={
          <IconButton
            size="small"
            onClick={() => {
              // ì•ˆë‚´ ë©”ì‹œì§€ ë‹«ê¸°
              const messageElement = document.querySelector(".MuiAlert-root");
              if (messageElement) {
                // DOM ì§ì ‘ ì¡°ì‘ ëŒ€ì‹  ìƒíƒœ ë³€ìˆ˜ ì‚¬ìš©
                const alertBox = messageElement.closest(".MuiAlert-root");
                if (alertBox) {
                  alertBox.parentElement?.removeChild(alertBox);
                }
              }
            }}
          >
            <CloseIcon fontSize="small" />
          </IconButton>
        }
      >
        <AlertTitle>ì‚¬ìš© íŒ</AlertTitle>
        <Typography variant="body2">
          â€¢ <strong>ê·¼ë¬´ í…œí”Œë¦¿ ê´€ë¦¬</strong> ë²„íŠ¼ìœ¼ë¡œ ì˜¤í”ˆ/ë¯¸ë“¤/ë§ˆê° í…œí”Œë¦¿ì„
          ì¶”ê°€í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          <br />
          â€¢ ì¼ì •ì„ í´ë¦­í•˜ë©´ ê·¼ë¬´ìë³„ ì‹œê°„ì„ ê°œë³„ì ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          <br />â€¢ ë¯¸ë°°ì •(íšŒìƒ‰), ì¸ì›ë¶€ì¡±(ì£¼í™©ìƒ‰), ì¸ì›ì´ˆê³¼(ë…¸ë€ìƒ‰)ê°€ ìƒ‰ìƒìœ¼ë¡œ
          í‘œì‹œë©ë‹ˆë‹¤.
        </Typography>
      </Alert>
    </>
  );
};

export default SchedulePage;

// If you still get "not a module" errors, you can add this line:
// export {};
